services:
  # MongoDB
  mongodb:
    image: mongo:7.0
    container_name: sanseal-mongodb
    restart: unless-stopped
    ports:
      - "27017:27017"
    environment:
      MONGO_INITDB_ROOT_USERNAME: admin
      MONGO_INITDB_ROOT_PASSWORD: sanseal_dev_2026
      MONGO_INITDB_DATABASE: sanseal
    volumes:
      - mongodb_data:/data/db
      - mongodb_config:/data/configdb
    networks:
      - sanseal-network
    healthcheck:
      test: [ "CMD", "mongosh", "--eval", "db.adminCommand('ping')" ]
      interval: 10s
      timeout: 5s
      retries: 5

  # Redis
  redis:
    image: redis:7.2-alpine
    container_name: sanseal-redis
    restart: unless-stopped
    ports:
      - "6379:6379"
    command: redis-server --appendonly yes --requirepass sanseal_redis_2026
    volumes:
      - redis_data:/data
    networks:
      - sanseal-network
    healthcheck:
      test: [ "CMD", "redis-cli", "-a", "sanseal_redis_2026", "ping" ]
      interval: 10s
      timeout: 5s
      retries: 5

  # RabbitMQ
  rabbitmq:
    image: rabbitmq:3.13-management-alpine
    container_name: sanseal-rabbitmq
    restart: unless-stopped
    ports:
      - "5672:5672" # AMQP
      - "15672:15672" # Management UI
    environment:
      RABBITMQ_DEFAULT_USER: admin
      RABBITMQ_DEFAULT_PASS: sanseal_rmq_2026
      RABBITMQ_DEFAULT_VHOST: sanseal
    volumes:
      - rabbitmq_data:/var/lib/rabbitmq
    networks:
      - sanseal-network
    healthcheck:
      test: [ "CMD", "rabbitmq-diagnostics", "-q", "ping" ]
      interval: 10s
      timeout: 5s
      retries: 5

  # MinIO
  minio:
    image: minio/minio:latest
    container_name: sanseal-minio
    restart: unless-stopped
    ports:
      - "9000:9000" # API
      - "9001:9001" # Console
    environment:
      MINIO_ROOT_USER: admin
      MINIO_ROOT_PASSWORD: sanseal_minio_2026
    command: server /data --console-address ":9001"
    volumes:
      - minio_data:/data
    networks:
      - sanseal-network
    healthcheck:
      test: [ "CMD", "mc", "ready", "local" ]
      interval: 10s
      timeout: 5s
      retries: 5

  # MinIO Setup
  minio-setup:
    image: minio/mc:latest
    container_name: sanseal-minio-setup
    depends_on:
      minio:
        condition: service_healthy
    networks:
      - sanseal-network
    entrypoint: >
      /bin/sh -c " mc alias set sanseal http://minio:9000 admin sanseal_minio_2026; mc mb --ignore-existing sanseal/posts; mc mb --ignore-existing sanseal/banners; mc mb --ignore-existing sanseal/avatars; mc anonymous set download sanseal/posts; mc anonymous set download sanseal/banners; mc anonymous set download sanseal/avatars; echo 'MinIO buckets created successfully'; "

# Networks
networks:
  sanseal-network:
    driver: bridge

# Volumes
volumes:
  mongodb_data:
  mongodb_config:
  redis_data:
  rabbitmq_data:
  minio_data:

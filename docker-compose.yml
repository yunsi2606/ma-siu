services:
  # ===== Infrastructure =====

  # MongoDB
  mongodb:
    image: mongo:7.0
    container_name: masiu-mongodb
    restart: unless-stopped
    ports:
      - "27017:27017"
    environment:
      MONGO_INITDB_ROOT_USERNAME: admin
      MONGO_INITDB_ROOT_PASSWORD: masiu_dev_2026
      MONGO_INITDB_DATABASE: masiu
    volumes:
      - mongodb_data:/data/db
      - mongodb_config:/data/configdb
    networks:
      - masiu-network
    healthcheck:
      test: [ "CMD", "mongosh", "--eval", "db.adminCommand('ping')" ]
      interval: 10s
      timeout: 5s
      retries: 5

  # Redis
  redis:
    image: redis:7.4-alpine
    container_name: masiu-redis
    restart: unless-stopped
    ports:
      - "6379:6379"
    command: redis-server --appendonly yes --requirepass masiu_redis_2026
    volumes:
      - redis_data:/data
    networks:
      - masiu-network
    healthcheck:
      test: [ "CMD", "redis-cli", "-a", "masiu_redis_2026", "ping" ]
      interval: 10s
      timeout: 5s
      retries: 5

  # RabbitMQ
  rabbitmq:
    image: rabbitmq:3.13-management-alpine
    container_name: masiu-rabbitmq
    restart: unless-stopped
    ports:
      - "5672:5672"
      - "15672:15672"
    environment:
      RABBITMQ_DEFAULT_USER: admin
      RABBITMQ_DEFAULT_PASS: masiu_rmq_2026
      RABBITMQ_DEFAULT_VHOST: masiu
    volumes:
      - rabbitmq_data:/var/lib/rabbitmq
    networks:
      - masiu-network
    healthcheck:
      test: [ "CMD", "rabbitmq-diagnostics", "-q", "ping" ]
      interval: 10s
      timeout: 5s
      retries: 5

  # MinIO
  minio:
    image: minio/minio:latest
    container_name: masiu-minio
    restart: unless-stopped
    ports:
      - "9000:9000"
      - "9001:9001"
    environment:
      MINIO_ROOT_USER: admin
      MINIO_ROOT_PASSWORD: masiu_minio_2026
    command: server /data --console-address ":9001"
    volumes:
      - minio_data:/data
    networks:
      - masiu-network
    healthcheck:
      test: [ "CMD", "mc", "ready", "local" ]
      interval: 10s
      timeout: 5s
      retries: 5

  # ===== API Gateway =====

  api-gateway:
    build:
      context: .
      dockerfile: src/ApiGateway/Dockerfile
    container_name: masiu-api-gateway
    restart: unless-stopped
    ports:
      - "5300:8300"
    environment:
      - ASPNETCORE_ENVIRONMENT=Production
      - ASPNETCORE_URLS=http://+:8300
      - MongoDB__ConnectionString=mongodb://admin:masiu_dev_2026@mongodb:27017
      - Redis__ConnectionString=redis:6379,password=masiu_redis_2026
      - RabbitMQ__Host=rabbitmq
      - RabbitMQ__Username=admin
      - RabbitMQ__Password=masiu_rmq_2026
    depends_on:
      mongodb:
        condition: service_healthy
      redis:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
    networks:
      - masiu-network

  # ===== Services =====

  auth-service:
    build:
      context: .
      dockerfile: src/Services/AuthService/Dockerfile
    container_name: masiu-auth-service
    restart: unless-stopped
    ports:
      - "5201:8201"
    environment:
      - ASPNETCORE_ENVIRONMENT=Production
      - ASPNETCORE_URLS=http://+:8201
      - MongoDB__ConnectionString=mongodb://admin:masiu_dev_2026@mongodb:27017
      - Redis__ConnectionString=redis:6379,password=masiu_redis_2026
    depends_on:
      mongodb:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - masiu-network

  user-service:
    build:
      context: .
      dockerfile: src/Services/UserService/Dockerfile
    container_name: masiu-user-service
    restart: unless-stopped
    ports:
      - "5202:8202"
    environment:
      - ASPNETCORE_ENVIRONMENT=Production
      - ASPNETCORE_URLS=http://+:8202
      - MongoDB__ConnectionString=mongodb://admin:masiu_dev_2026@mongodb:27017
    depends_on:
      mongodb:
        condition: service_healthy
    networks:
      - masiu-network

  post-service:
    build:
      context: .
      dockerfile: src/Services/PostService/Dockerfile
    container_name: masiu-post-service
    restart: unless-stopped
    ports:
      - "5203:8203"
    environment:
      - ASPNETCORE_ENVIRONMENT=Production
      - ASPNETCORE_URLS=http://+:8203
      - MongoDB__ConnectionString=mongodb://admin:masiu_dev_2026@mongodb:27017
      - Redis__ConnectionString=redis:6379,password=masiu_redis_2026
      - RabbitMQ__Host=rabbitmq
      - RabbitMQ__Username=admin
      - RabbitMQ__Password=masiu_rmq_2026
      - MinIO__Endpoint=minio:9000
      - MinIO__AccessKey=admin
      - MinIO__SecretKey=masiu_minio_2026
    depends_on:
      mongodb:
        condition: service_healthy
      redis:
        condition: service_healthy
      minio:
        condition: service_healthy
    networks:
      - masiu-network

  voucher-service:
    build:
      context: .
      dockerfile: src/Services/VoucherService/Dockerfile
    container_name: masiu-voucher-service
    restart: unless-stopped
    ports:
      - "5204:8204"
    environment:
      - ASPNETCORE_ENVIRONMENT=Production
      - ASPNETCORE_URLS=http://+:8204
      - MongoDB__ConnectionString=mongodb://admin:masiu_dev_2026@mongodb:27017
      - Redis__ConnectionString=redis:6379,password=masiu_redis_2026
      - RabbitMQ__Host=rabbitmq
      - RabbitMQ__Username=admin
      - RabbitMQ__Password=masiu_rmq_2026
    depends_on:
      mongodb:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - masiu-network

  affiliate-service:
    build:
      context: .
      dockerfile: src/Services/AffiliateService/Dockerfile
    container_name: masiu-affiliate-service
    restart: unless-stopped
    ports:
      - "5205:8205"
    environment:
      - ASPNETCORE_ENVIRONMENT=Production
      - ASPNETCORE_URLS=http://+:8205
      - MongoDB__ConnectionString=mongodb://admin:masiu_dev_2026@mongodb:27017
      - Redis__ConnectionString=redis:6379,password=masiu_redis_2026
    depends_on:
      mongodb:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - masiu-network

  notification-service:
    build:
      context: .
      dockerfile: src/Services/NotificationService/Dockerfile
    container_name: masiu-notification-service
    restart: unless-stopped
    ports:
      - "5206:8206"
    environment:
      - ASPNETCORE_ENVIRONMENT=Production
      - ASPNETCORE_URLS=http://+:8206
      - MongoDB__ConnectionString=mongodb://admin:masiu_dev_2026@mongodb:27017
      - Redis__ConnectionString=redis:6379,password=masiu_redis_2026
      - RabbitMQ__Host=rabbitmq
      - RabbitMQ__Username=admin
      - RabbitMQ__Password=masiu_rmq_2026
    depends_on:
      mongodb:
        condition: service_healthy
      redis:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
    networks:
      - masiu-network

  reward-service:
    build:
      context: .
      dockerfile: src/Services/RewardService/Dockerfile
    container_name: masiu-reward-service
    restart: unless-stopped
    ports:
      - "5207:8207"
    environment:
      - ASPNETCORE_ENVIRONMENT=Production
      - ASPNETCORE_URLS=http://+:8207
      - MongoDB__ConnectionString=mongodb://admin:masiu_dev_2026@mongodb:27017
      - Redis__ConnectionString=redis:6379,password=masiu_redis_2026
    depends_on:
      mongodb:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - masiu-network

  task-service:
    build:
      context: .
      dockerfile: src/Services/TaskService/Dockerfile
    container_name: masiu-task-service
    restart: unless-stopped
    ports:
      - "5208:8208"
    environment:
      - ASPNETCORE_ENVIRONMENT=Production
      - ASPNETCORE_URLS=http://+:8208
      - MongoDB__ConnectionString=mongodb://admin:masiu_dev_2026@mongodb:27017
      - RabbitMQ__Host=rabbitmq
      - RabbitMQ__Username=admin
      - RabbitMQ__Password=masiu_rmq_2026
    depends_on:
      mongodb:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
    networks:
      - masiu-network

  # ===== Frontend =====

  admin-dashboard:
    build:
      context: ./src/Apps/app-admin
      dockerfile: Dockerfile
    container_name: masiu-admin
    restart: unless-stopped
    ports:
      - "3000:3000"
    environment:
      - NEXTAUTH_URL=http://localhost:3000
      - NEXTAUTH_SECRET=masiu-nextauth-secret-2026
    networks:
      - masiu-network

  # ===== Nginx Reverse Proxy =====

  nginx:
    image: nginx:alpine
    container_name: masiu-nginx
    restart: unless-stopped
    ports:
      - "80:80"
    volumes:
      - ./deploy/nginx/nginx.conf:/etc/nginx/nginx.conf:ro
    depends_on:
      - api-gateway
      - admin-dashboard
    networks:
      - masiu-network

# Networks
networks:
  masiu-network:
    driver: bridge

# Volumes
volumes:
  mongodb_data:
  mongodb_config:
  redis_data:
  rabbitmq_data:
  minio_data:
